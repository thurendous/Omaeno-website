<!doctype html>
<html lang="ja" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.1">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Hello Web3 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Hello Web3 Atom Feed">



<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1RJPDZD7CN"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-1RJPDZD7CN",{anonymize_ip:!0})</script><title data-rh="true">EVM ディープダイブ - super coder への道 🥷 💻Part 2 | Hello Web3</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://omaeno.xyz/blog/EVM-deep-dive-part2"><meta data-rh="true" name="docusaurus_locale" content="ja"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="ja"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="Omaeno Web3" content="programming, Solidity, Web3, NFT, blockchain"><meta data-rh="true" property="og:title" content="EVM ディープダイブ - super coder への道 🥷 💻Part 2 | Hello Web3"><meta data-rh="true" name="description" content="Hello, everybody!"><meta data-rh="true" property="og:description" content="Hello, everybody!"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-05-13T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/thurendous"><meta data-rh="true" property="article:tag" content="EVM,opcode,Etheruem,blockchain,examples"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://omaeno.xyz/blog/EVM-deep-dive-part2"><link data-rh="true" rel="alternate" href="https://omaeno.xyz/blog/EVM-deep-dive-part2" hreflang="ja"><link data-rh="true" rel="alternate" href="https://omaeno.xyz/en/blog/EVM-deep-dive-part2" hreflang="en"><link data-rh="true" rel="alternate" href="https://omaeno.xyz/blog/EVM-deep-dive-part2" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.5b67266f.css">
<link rel="preload" href="/assets/js/runtime~main.55ab35fc.js" as="script">
<link rel="preload" href="/assets/js/main.ffb69ee1.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">メインコンテンツまでスキップ</a></div><div class="announcementBar_mb4j" style="background-color:#fafbfc;color:#091E42" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="announcementBarContent_xLdY">The website is still a work in progress. Please feel free to give our <a target="_blank" rel="noopener noreferrer" href="https://github.com/thurendous/Omaeno-website">github</a> a star or follow us on <a target="_blank" rel="noopener noreferrer" href="https://twitter.com/Markwu_crypto">twitter</a>!</div><button type="button" class="clean-btn close announcementBarClose_gvF7" aria-label="閉じる"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Omaeno Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Omaeno Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Knowledge</a><a class="navbar__item navbar__link" href="/docs/category/solidity-basics">Solidity</a><a class="navbar__item navbar__link" href="/docs/category/ethersjs">Ethers.js</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/unitConverter">Unit Converter</a><a href="https://github.com/thurendous/Omaeno-website" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/EVM-deep-dive-part2">EVM ディープダイブ - super coder への道 🥷 💻Part 2</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/EVM-deep-dive-part1">EVM ディープダイブ - super coder への道 🥷 💻Part 1</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/checks-effects-interactions">CEIとは : Checks Effects Interactions</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Zero-knowledge-proofs-explained-by-examples">ゼロ知識証明を事例で理解する</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/opcode-basics">opcodeについて</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/what-is-ERC1155-with-code-explained">ERC1155とはなんぞや（コード解説）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/private-variable-in-solidity-with-code-explained">solidityにおいてなぜprivateな変数はprivateではないのか</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/what-is-ERC721-and-NFT-with-code-explained">NFT、ERC721とはなんぞや（コード解説）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/web3-term-dictionary">Web3 Term Dictionary</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/why-crypto-is-the-future">Why Crypto is the Future</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">EVM ディープダイブ - super coder への道 🥷 💻Part 2</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-05-13T00:00:00.000Z" itemprop="datePublished">2023年5月13日</time> · <!-- -->約8分</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/thurendous" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/thurendous.png" alt="Thurendous"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/thurendous" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Thurendous</span></a></div><small class="avatar__subtitle" itemprop="description">Think borderlessly</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>Hello, everybody!</p><h1>Never Give Up</h1><p>以前書いた時から、EVM について理解できてきているので、当時は読みづらかった技術系の文章もすらすら読めるようになりました。そこで EVM のことあるいは他のなにかで頑張っているあなたももしかして何かができずに悩んでいるのかもしれません。</p><p>ここで行っておきますが、僕もそうだったので、安心してください。そのうち理解できるようになるだろう。</p><p>ちなみに、こちらの画像をみてごらん。</p><p>本当に経験した人しかわからないと思いますし、経験したとしてももう一度経験すると、やはり信じられない気持ちになると思うよね。</p><p>何がどうなっても、続けることが一番大切。</p><ul><li>遅くてもいい</li></ul><p><img loading="lazy" src="/assets/images/0plus1is1-67419ad8c3e6896eb20d34b24f09e059.png" width="828" height="382" class="img_ev3q"></p><ul><li>理想と現実</li></ul><p><img loading="lazy" src="/assets/images/meikyuu-8f55c9a4c82238d91b81b7627ee94a99.png" width="820" height="380" class="img_ev3q"></p><ul><li>「続けてても意味ない」</li></ul><p><img loading="lazy" src="/assets/images/thisispointless-c42e9d59813d74a2a459dc60158cfd9c.png" width="934" height="524" class="img_ev3q"></p><ul><li>最初の第一歩が一番むずいけどね</li></ul><p><img loading="lazy" src="/assets/images/keeptrying-d7c22670dd835427081a62ef78787bc0.png" width="792" height="742" class="img_ev3q"></p><ul><li>三日坊主 VS 続ける</li></ul><p><img loading="lazy" src="/assets/images/keeptryingallday-55e3b5ef7bf92e4188f07f753f51c8fd.png" width="886" height="516" class="img_ev3q"></p><hr><p>今回は、メモリーについて説明する。</p><p>Part 1 では、EVM がどのようにバイトコードのどこを狙って run させるかを見てきた。 それは、外部の calldata を入力してきてコントラクトのどの関数を呼んでいるかを判別して run すべきバイトコードの箇所を決めていることがわかった。</p><p>これを理解することで、関数の署名・call stack・calldata・EVM のオペコード について理解が進んだと思う。</p><p>Part 2 では、EVM におけるメモリーについて色々見ていこう。</p><h1>Memory</h1><p>Part1 のコードを思いだしてみて。<code>1_Storage.sol</code>というコントラクトがあった。</p><div class="language-sol codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sol codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pragma</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">solidity</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token version number" style="color:#36acaa">0.7.0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token version number" style="color:#36acaa">0.9.0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">contract</span><span class="token plain"> </span><span class="token class-name">Storage</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">store</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">uint256</span><span class="token plain"> num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        number </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> num</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">retrieve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">view</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">returns</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">uint256</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>これのバイトコードを生成すると、こうなっている。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">608060405234801561001057600080fd....</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>今回はこの部分にフォーカスして説明したいと思う。一番最初の 5bytes だ。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">6080604052</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">60 80                       =   PUSH1 0x80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">60 40                       =   PUSH1 0x40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">52                          =   MSTORE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>これが聞いたことあるがかもしれないけど、いわゆる「free memory pointer」だ。</p><p>これを理解するには、まずはコントラクトのメモリーを理解しなければならない。</p><h1>メモリのデータ構造</h1><p>コントラクトのメモリはシンプルにいうと、byte の array だ。32bytes(256bit)あるいは 1byte(8bit)の単位として保存される。読まれるときには、32bytes(256bit)単位ごとになる。下記の画像は話した内容を具現化したもの。</p><p><img loading="lazy" src="/assets/images/memoryImpression-bf6e64d85b0989e34e97553f008b2e36.png" width="559" height="427" class="img_ev3q"></p><p>この機能は３つの opcode に左右されている。</p><ul><li><code>MSTORE(x, y)</code>: 32 byte(256 bit) の値 y をメモリのロケーションの x に保存</li><li><code>MLOAD(x)</code>: 32 byte(256 bit) のメモリの場所をロケーション x から読み出し、スタックに入れる</li><li><code>MSOTRE8(x, y)</code>: 1 byte (8 bit)の値 y をメモリロケーションの x に保存する</li></ul><p>メモリロケーションのことはどこからメモリを読み取る/書き込むかを決めていると考えてよい。もし、1byte より多く読み取る/書き込むことをしたいのであれば、そのまま継続すればよいだけの話になる。</p><h1>EVM playground</h1><p>この <a href="https://www.evm.codes/playground?fork=shanghai" target="_blank" rel="noopener noreferrer">EVM playground</a> はあなたの理解の手助けができるだろう。Run をクリックして、右上の矢印をクリックしてみよう。矢印ボタンはコードの稼働プロセスをたどっていってくれる。スタック、メモリはどうなっているのかもわかる。すごく直感的なツールだと感心する。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// MSTORE 32 bytes 0x11...1 at memory location 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PUSH32 0x1111111111111111111111111111111111111111111111111111111111111111</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PUSH1 0x00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSTORE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// MSTORE8 1 byte 0x22 at memory location 32 (0x20 in hex)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PUSH1 0x22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PUSH1 0x20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSTORE8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// MSTORE8 1 byte 0x33 at memory location 33 (0x21 in hex)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PUSH1 0x33</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PUSH1 0x21</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSTORE8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// MLOAD 32 bytes to the call stack from memory location 0 ie 0-32 bytes of memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PUSH1 0x00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MLOAD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// MLOAD 32 bytes to the call stack from memory location 32 ie 32-64 bytes of memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PUSH1 0x20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MLOAD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// MLOAD 32 to the call stack from memory location 33 ie 33-65 bytes of memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PUSH1 0x21</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MLOAD</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2Fe3e29126-2954-40e3-bc1b-7ca5e780fd1c_1500x850.png" class="img_ev3q"></p><p>opcode についても、英語だが説明文がついている。</p><p>やってみて変だなと思うことはないのか？
まず、MSTORE8 を使って 1 byte の 0x22 をメモリの 0x20 に書き込んでいるつもりだが、何故かメモリはここから、</p><p><img loading="lazy" src="https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F954d54e6-0bce-4de3-a61d-dd41fdae49c7_836x152.png" class="img_ev3q"></p><p>こう変わるんだ。</p><p><img loading="lazy" src="https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fbucketeer-e05bbc84-baa3-437e-9518-adb32be77984.s3.amazonaws.com%2Fpublic%2Fimages%2F225fde5a-09bf-4a24-a702-88ad5010951e_836x176.png" class="img_ev3q"></p><p>この余分なゼロってなんだと思うだろう。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="メモリの拡張">メモリの拡張<a class="hash-link" href="#メモリの拡張" title="見出しへの直接リンク">​</a></h2><p>コントラクトがメモリへなにかを書き込む際、byte 数に従ってガス代を支払っている。これが opcode のコストと言う。もし、これまでメモリへ書き込んだことがない場所へ書き込む場合、追加的にメモリ拡張のコストがかかる。</p><p>これまで書き込んだことがない箇所へ書き込む場合、メモリは 32bytes(256bit)拡張されることになる。</p><blockquote><p>メモリのコストの増え方に関しては、最初の 724bytes は線形的に増加するが、それ以降は二次指数関数的になる。</p></blockquote><p>上の例では、まず 0x00 のロケーションへ 32 bytes 書き込んだが、そこからさらに書き込むとなると、メモリ拡張をしなければならず、結果的に、メモリは 64 bytes になった。</p><p>メモリにある保存領域の最初のデフォルト値はゼロ。だから 2200000000000000000000000000000000000000000000000000000000000000 がメモリに追加された。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="メモリは-byte-の-array-だから">メモリは byte の Array だから<a class="hash-link" href="#メモリは-byte-の-array-だから" title="見出しへの直接リンク">​</a></h2><p>次に注意しないといけないのは、メモリロケーションの 33(0x21)から MLOAD したときに、下記の値が返された。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">3300000000000000000000000000000000000000000000000000000000000000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>32 bytes ずつ読み込んでいなくても、読み込めるということであった。</p><p>memory はただの byte array なので、どこの場所からでも読み込めることを覚えて下さい。32bytes の制限は特になく、どこからでも byte 単位から読み込める。</p><blockquote><p>関数内でのみ新たにメモリを作成することができます。それは新たにインスタンス化された複雑な型（例えば <code>new int[...]</code> など）であったり、ストレージ参照変数からコピーされたものであったりします。</p></blockquote><p>現在、我々はデータ構造について理解できたので、free memory の話へ戻ろう。</p><h1>Free Memory Pointer</h1><p>Free Memory Pointer とは、簡単にいうとメモリロケーションのポインターであり、Free Memory がどこからスタートすべきなのかを記録している。言い換えると、メモリのロケーションはどこまで書き込まれていて、どこから書き込むべきなのかを記録している。</p><p>これはコントラクトがメモリを上書きするのを防ぐためでもある。</p><p>変数がメモリへ書き込むときに、コントラクトはまず Free Memory Pointer を参照し、どこから書き込むべきかを決めないといけない。それから Free Memory Pointer をアップデートし、最新のメモリの「境界値」あるいは「オフセット」を記録する。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  newFreeMemoryPointer = freeMemoryPointer + dataSizeBytes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="bytecode">Bytecode<a class="hash-link" href="#bytecode" title="見出しへの直接リンク">​</a></h2><p>先程にも言及したように、Free Memory Pointer は最初の runtime bytecode のこの部分によって定義される。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">60 80                       =   PUSH1 0x80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">60 40                       =   PUSH1 0x40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">52                          =   MSTORE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>これは基本的に何を言っているかというと、Free Memory Pointer はメモリロケーションの 0x40(64 in decimal)で、値は 0x80(128 in decimal)となる。</p><p>すぐに疑問に思うのは、なぜこの数字なのということだろう。</p><p>答え：</p><blockquote><p>0x00 - 0x3f (64 bytes): scratch space</p><p>0x40 - 0x5f (32 bytes): free memory pointer</p><p>0x60 - 0x7f (32 bytes): zero slot</p></blockquote><p>0x40 は solidity が定義した一番最初の Free Memory Pointer のメモリロケーションだ。値 0x80 は単に最初の 4 つの 32 bytes のポジションを記録している。</p><p>これらの予約されたメモリについて</p><ul><li>Scrach space: inline assembly のハッシングメソッドとして使っても良い</li><li>Free memroy pointer: 今のメモリのサイズ、free memory のスタートロケーション、最初は 0x80</li><li>The zero slot: 動的な Memory Array の初期値であり、どんなときにでも書き込まれることはない</li></ul><h1>コントラクトのメモリ</h1><p>リアルなコントラクトのメモリについて見ていくとしようか。</p><p>非常にシンプルなコントラクトを作成した。こいつの名は <code>MemoryLane</code>。たった一個の関数を持っており、２つの Array を持っている。それから b<!-- -->[0]<!-- -->に値 1 を付与する。</p><p>3 行程度のコードだけど、かなり多くのことが起きているよ。</p><div class="language-sol codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sol codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// SPDX-License-Identifier: MIT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pragma</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">solidity</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">^</span><span class="token version number" style="color:#36acaa">0.8.3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">contract</span><span class="token plain"> </span><span class="token class-name">MemoryLane</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">memoryLane</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">pure</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin">bytes32</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">memory</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin">bytes32</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">memory</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        b</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">bytes32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">uint256</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上記のコードをもう一度 <a href="https://remix.ethereum.org/" target="_blank" rel="noopener noreferrer">remix</a> へ投入。</p><p>それから、コンパイルし、デプロイしてください。</p><p><code>memoryLane()</code>関数を run して、debugging mode へ入ってください。</p><p>opcode を少しずつ見ていこう。</p><p>少し簡単なバージョンを<a href="https://www.evm.codes/playground?unit=Wei&amp;codeType=Mnemonic&amp;code=%27Vg*%28_I...1W0GJ_%21%21%21%21z00FK22WJQ0Y22z20F8K33W33Q1Y33z21F8d%28v0Z0-Jq00Xd%28vJZJ-64q20Xdv33Z33-65q21Xpp%27%7EN+locatioCzG1_wppVv7o7hBcall+stack+from%7EuIIIIq%28+ofNzp%5Cnj+bytegSTOREdw%29*_+0xZ9BY9Chex%7DzXpM%29W+at%7EV%2F%2F+MQ+%7B0x2N+memoryKwg8+1j_J32I11GpPUSHFpMgCn+Be+9+i7+t*+J%29LOAD%28js%21uu%01%21%28%29*79BCFGIJKNQVWXYZ_dgjpquvwz%7E_&amp;fork=shanghai" target="_blank" rel="noopener noreferrer">EVM playground</a>へ入れている。その opcode はそのようになっている。</p><p>この簡単なバージョンは opcode を順番に構成し、JUMP などのメモリ操作と関連しないことを除外した。いろいろコメントもしているので、参照してほしい。</p><p>このコードは 6 部分から構成されていて、これから dive in する。</p><p>play ground を使うことを強くおすすめする。</p><h1>Free Memory Pointer Initialisation (EVM Playground Lines 1-15)</h1><p>まず、“free memory pointer initialisation”からやっていく。上記でもあったように、0x80(128 in decimal)をスタックに入れる。これは free memory pointer の値として保存される。Solidity の memory のレイアウトを決めている。</p><p><img loading="lazy" src="/assets/images/memory00-64684a54a90cd8fad4035fb6bc659256.png" width="726" height="129" class="img_ev3q"></p><p>この段階では、まだメモリにはなにもない。</p><p><img loading="lazy" src="/assets/images/memory01-bedf15c76b97ec5039e2dc0c9d1acd30.png" width="722" height="166" class="img_ev3q"></p><p>続いて free memory pointer のロケーションの 0x40(64 in decimal)をプッシュする。</p><p>最後に、MSTORE を使って、0x40 ロケーションに 0x80 の値を記録。</p><p>この後、スタックには何もなく、メモリになにかを残せたことになる。メモリは 16 進数になっており、数字ごとに 4bit のデータを記録している。</p><p>今となって、192 の 16 進数の数字となっている（数字 2 桁 = 1 byte = 8 bit）。</p><p>先程の内容を思い出してください。最初の 64bytes は scrach space で、次の 32bytes は free memory pointer になる。これはまさに下記の状態。</p><p><img loading="lazy" src="/assets/images/memory02-5c58412a5109dbc9f344363980e9a18e.png" width="721" height="197" class="img_ev3q"></p><h1>Memory Allocation Variable “a” &amp; Free Memory Pointer Update (EVM Playground Lines 16-34)</h1><p>残りの部分については、簡単にするために一旦最後の飛ばしてハイレベルの概要を見てみよう。</p><p>次のメモリに関して、変数<code>a</code>(bytes32<!-- -->[5]<!-- -->)のことを配置して free memory pointer をアップデートするということをしなければならないのがわかる。</p><p>コンパイラは array size によってどれくらいのスペースが必要か決定する。</p><blockquote><p>メモリ array の要素の占める領域は 32 bytes の倍数になる。これは <code>bytes1[]</code>に対しても通用する。ただし、<code>bytes</code> や <code>string</code> は違う。</p></blockquote><p>array のサイズ ×32bytes でどれくらいのメモリを食うかわかる。</p><p>この場合、5 <!-- -->*<!-- --> 32 bytes で、0xa0 (160)になるのだ。したがってその値は stack にプッシュされ、現在の free memory pointer に保存された。</p><p>この後、前の free memory pointer の値と足し算をして、値 0x120 (288)が生成された。この値が free memory pointer に保存された。</p><p>stack には変数<code>a</code>メモリをロケーション 0x80 にキープして後から参照できるようにしている。<code>0xffff</code>は JUMP のロケーションを意味しており、関係ないので当面は無視してよい(stack の underflow を防ぐためにある)。</p><p><img loading="lazy" src="/assets/images/memory03-45df8d05acd1c466840636031aeb0c69.png" width="719" height="255" class="img_ev3q"></p><h1>Memory Initialisation Variable “a” (EVM Playground Lines 35-95)</h1><p>今ではメモリに保存されて free memory pointer がアップデートされた。ここからは変数<code>a</code>のメモリにおける初期化をする。変数は宣言されて値代入していないので、ゼロ値になっているはず。</p><p>これをするためには、EVM の CALLDATACOPY を使って実施する。この opcode は３つの引数が必要：</p><ul><li>memoryOffset（メモリロケーションへコピーする場所）</li><li>calldataOffset（calldata における byte offset のこと）</li><li>size（コピーする byte size）</li></ul><p>今回の場合、memoryOffset は<code>a</code>のメモリロケーション 0x80。</p><p>calldataOffset は実際の calldata のサイズ、なぜならそもそも calldata の copy がいらない。メモリをゼロ値で初期化したい。結果的にサイズが 0xa0 あるいは 160 bytes になる。</p><p>ここで、メモリが 288 bytes になったとわかる(zero slot も含めて)。stack は今もう一度変数のメモリロケーションと JUMP ロケーションを持っている状態。</p><p>（その間に細かい操作については、何度も pop しているのがあるが、個人的にはまだなぞで、わかる方なら教えて下さい）</p><h1>Memory Allocation Variable “b” &amp; Free Memory Pointer Update (EVM Playground Lines 96-112)</h1><p>ここでの操作は上記の流れと非常に似ているが、ただし、今回は<code>bytes32[2] memory b</code>となる。</p><p>free memory pointer を 0x160(352 in decimal)にアップデートする(前の free memory pointer 288 + 新しい変数のサイズ 64 bytes)。</p><p>注意としては、free memory pointer はメモリにて 0x160 にアップデートされ、そこで現在は変数<code>b</code>のメモリロケーション(0x120)をスタックに入れてある。</p><p><img loading="lazy" src="/assets/images/memory04-21f31db9f1b092990a9a117ab315b165.png" width="713" height="407" class="img_ev3q"></p><h1>Memory Initialisation Variable “b” (EVM Playground Lines 113-162)</h1><p>続いて変数<code>b</code>初期化について説明する。</p><p>現在、メモリは 352bytes へ拡張された。スタックにはメモリロケーションを 2 個持っている。</p><h1>Assign Value to <code>b[0]</code> (EVM Playground Lines 163-207)</h1><p>やっと最後の段階に来れた。正直にいって難しかった。</p><p>ここでは、array <code>b</code> の index <code>0</code>に値を付与したい。</p><p>コードでは b<!-- -->[0]<!-- --> = 1 となっている。</p><p>まず、この値が stack に突っ込まれる。その後、bit shift が起きるが、これ移動したのは 0 で何も変わりはないことを意味する。</p><p>次に array の index には 0x00 へ書き込まれ、0 positon へ書き込むことを意味する。その際に、array length の 2 を超えていないことをチェック。もし条件をクリアできない場合、異なるバイトコードのポジションへ飛び、エラーハンドリングの部分へ飛ばされる。</p><p>MUL、ADD opcode はメモリいにおいて値が書き込まれる場所を決めている。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0x20 (32 in decimal) * 0x00 (0 in decimal) = 0x00</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>メモリの array は 32 byte 単位であることを思い出してほしい。こちらは 0x00 になるので、offset は不要でそのまま 0 のポジションから書着込む。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0x00 + 0x120 = 0x120 (288 in decimal)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ADD は offset の値をメモリにある変数 b のロケーションを定義するように使われた。offset は今回 0 なので、そのまま、free memory pointer の位置に書き込むこととなる。</p><p>一番最後に、MSTORE を使って値 0x01 をメモリロケーションの 0x120 へ書き込む。そして、スタックにあるすべての要素を pop し、終了。</p><p>これでメモリは<code>b[0] = 1</code>となっている。下から 3 行目のところに 1 という数字が入っているのがわかる。</p><p><img loading="lazy" src="/assets/images/memory05-98e5924ea9117797c28563e880002aec.png" width="716" height="381" class="img_ev3q"></p><p>今回の記事はここまで！Bye！</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="reference">Reference<a class="hash-link" href="#reference" title="見出しへの直接リンク">​</a></h2><p><a href="https://noxx.substack.com/p/evm-deep-dives-the-path-to-shadowy-d6b?s=r" target="_blank" rel="noopener noreferrer">EVM Deep Dives: The Path to Shadowy Super Coder 🥷 💻 - Part 2</a></p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>タグ:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/evm">EVM</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/opcode">opcode</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/etheruem">Etheruem</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/blockchain">blockchain</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/examples">examples</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/EVM-deep-dive-part2/2023-5-13-EVM-deep-dive-part2.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>このページを編集</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="ブログ記事のナビゲーション"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/EVM-deep-dive-part1"><div class="pagination-nav__sublabel">過去の記事</div><div class="pagination-nav__label">EVM ディープダイブ - super coder への道 🥷 💻Part 1</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#メモリの拡張" class="table-of-contents__link toc-highlight">メモリの拡張</a></li><li><a href="#メモリは-byte-の-array-だから" class="table-of-contents__link toc-highlight">メモリは byte の Array だから</a></li><li><a href="#bytecode" class="table-of-contents__link toc-highlight">Bytecode</a></li><li><a href="#reference" class="table-of-contents__link toc-highlight">Reference</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Knowledge</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Solidity</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/DJ9FrhWPDb" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/Markwu_crypto" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/thurendous/Omaeno-website" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Omaeno is built with love in Tokyo.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.55ab35fc.js"></script>
<script src="/assets/js/main.ffb69ee1.js"></script>
</body>
</html>